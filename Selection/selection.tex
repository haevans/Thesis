\chapter{Selection of \bsmumu events for the effective lifetime Measurement}
\label{selection_chapter}
The analysis described in Chapter X for the \bsmumu effective lifetime requires \bsmumu and \bhh decays to be identified in the data sets recorded by the LHCb experiment. Although \bsmumu decays leave a clear 2 muon signature in the detector, the selection of these decays is challenging because it is a very rare process and there are many other processes that can mimic a \BsMuMu decay in the detector. The background processes are described in Section~\ref{sec:backgroundoutline}. To understand different aspects of the selection and analysis of \BsMuMu decays, particle decays with a similar topology to \BsMuMu are used. \bhh decays, where $h = K, \pi$, are used because they have large branching fractions and are well understood from pervious LHCb analyses as well as a similar topology to \bsmumu decays. 
%The selection of \bhh decays is kept as close as possible to the selection of \bsmumu so they can be used as a validation channels.
The measurement of the \bmumu Branching Fractions, described in Chapter X, requires the use of \bujpsik decays, as well as \bmumu and \bhh decays, to be used as a noramlisation channel.
This Chapter describes the selection of \bmumu, \bhh and \bujpsik decays for the effective lifetime and Branching fraction analyses. The analyses share many of the same selection requirements. The selection occurs in several stages, and the development of the selection relies on simulated events which are detailed in Section~\ref{sec:MCsamples}. The first step to select decays is choosing what requirements to place on the trigger which is followed by a set of loose selection requirements to remove obvious background events. These two steps are described in Sections~\ref{sec:triggerRequirements} and \ref{sec:stripping}. A tighter selection is applied to the output of the stripping as described in Section~\ref{sec:offline_sel} and particle identification requirements are used in Section~\ref{sec:PID} to further reduced background events. Finally a multivariate classifier is described in Section~\ref{sec:BDT} used as the final step in the selection to reduced the backgrounds to a level suitable for the analysis in Chapter X to be preformed. Throughout this Chapter \bsmumu and \bdmumu are selected in the same way.

The LHCb collaboration has published a number of papers studying the \bsmumu decay, the selection described in this Chapter has been built up over a number of years by a range of different collaboration members. The studies detailed in sections X, X and Y was done for this thesis.





\subsection{Backgrounds}
\label{sec:backgroundoutline}
A \bs decaying into two muons leaves information in the LHCb detector with certain identifying characteristics. The two muons form a good vertex that is displaced from the primary vertex of the event because the Bs has a long lifetime and the combined momentum of the muons can be extrapolated backwards to the primary vertex because the muons are the only decay products of the \bs. There are other processes that occur in proton-proton decays that can leave information in the detector in a similar pattern to \bsmumu decays. The reconstruction, described in Section X, produces many \bsmumu candidates, the aim of the selection is to separate the real \bsmumu decays from the background in the reconstructed candidates.

%The background sources for \bsmumu decays can be split into two groups, those that have quite obvious difference from \bsmumu decays and those that do not. The first set can be removed from the data set by taking advantage of the obvious differences whilst keeping a high 

The main sources of background processes for \bsmumu decays are;
\begin{itemize}
\item Elastic collisions of protons, $pp \to p \mu^+{} \mu^{-} p$, can produce a pair of muons whilst the protons travel down the beam pipe. The muons produced have low transverse momentum.
\item Inelastic proton collisions can create two muons at the primary vertex. These muons can be combined to for a \bs that decays instantaneously. This type of background is prompt  combinatorial background. 
\item The $B_{S}^{0}\to\mu^{+}\mu^{-}\gamma$ decays can mimic \bsmumu when the photon is not reconstructed. The presence of the photon in the decay means that $B_{S}^{0}\to\mu^{+}\mu^{-}\gamma$ is not helicity surpassed and could therefore be a sizeable background, however the photon gains a large transverse momentum therefore when reconstructed as \bsmumu the \bs mass is much lower than expected.
\item \bsmumu candidates can be formed when muons produced in separated semi-leptonic decays are combined. These are known as long lived combinatorial background because the reconstructed \bs will not decay instantaneously.
\item Semi-leptonic decays when on to the daughters is mis-identified as a muon and/or is not detected can mimic \bsmumu decays. The resulting reconstructed mass of the \bs is lower than expected due to the missing particle information. The semi-leptonic decays that contribute to \bsmumu backgrounds in this way are \bdpimunu, \bsKmunu, \bpimumu, \bdpimumu and \bcjpsimunu where \jpsimumu.
\item \bhh decays, where $ h  = K, \pi$, can form background when both hadrons are mis-identified as muons. This usually occurs when the hadrons decay in flight. The mis-identification of the hadrons leads to the reconstructed \bs mass being lower than expected.
\end{itemize}

Separating the backgrounds from the \bsmumu decays can be done relatively straightly forwardly for many of the background processes by taking advantage of the obvious differences between the background and \bsmumu decays. However, distinguishing \bsmumu decays from long lived combinatorial backgrounds, and mis-idetificed \bhh and semi-leptonic decays is more challenging and \bsmumu decays must be sacrificed in order to remove a sufficient about of the background processes for the analysis to be performed. For the effective lifetime analysis the \bdmumu decay is not relevant and is therefore a background, however since the decays are extremely similar the \bsd masses are the only way to seperate the decays.

\subsection{Monte Carlo Samples}
\label{sec:MCsamples}
Simulated events are needed for the development of the selection for \bsmumu and \bhh decays and to study aspects of the analysis strategy. Monte Carlo simulated events and their passage through the LHCb detector, as described in Section X, are used. The advantage of simulated events is that a clean sample a particular type of particle decay can be produced in much greater numbers compared to what is seen in data. A large range of different simulated decays types have been used over time for the development of the selection, the simulated decays used directly for studies documented in this thesis are listed in Table~\ref{tab:MC_decays}.

\begin{table}[ht]
\begin{center}
\begin{tabular}{llll}
\hline
Decay 			& Year 	& Simulation Version 	& Generated Events \\ \hline 
\multicolumn{3}{c}{{\it Stripping selection studies selection}}  \\ \hline 
\bsmumu			& 2012	& sim06b  		& 2M			 \\ 
\bdmumu			& 2012	& sim06b  		& \\ 
\bdkpi			& 2012	& sim06b  		& \\ 
\bujpsik		& 2012	& sim06b  		& \\ 
\multicolumn{3}{c}{{\it Analysis method development}}  \\ \hline 
\bsmumu			& 2011 	& sim08   		& 0.5M		  \\ 
       			& 2012 	& sim08  		& 			 \\ 
        		& 2015	& sim09  		& 2M	 \\ 
        		& 2016	& sim09  		&  \\ 
\bdkpi			& 2011	& sim08  		& 0.8M  \\ 
        		& 2012	& sim08  		& 8.5M \\ 
        		& 2015	& sim09  		& 4M  \\ 
        		& 2016	& sim09  	 	&  \\ 
\bskk   		& 2012	& sim08  		& 7M \\ 
        		& 2015	& sim09   		&  \\  \hline
\multicolumn{3}{c}{{\it Multivarite classifer training}}  \\ \hline 
\bbbarmumux, p$_{T}$	& 2012 	& sim06 		& 	\\ \hline
\bbbarmumux, p$_{T}$	& 2012 	& sim06 		& \\ 	\hline
\bsmumu			& 2012	& sim06b  		& 2M			 \\ 
\hline
\end{tabular}
\caption{Simulated events used for developing the selection and the analysis method listed according to the studies the simulated events are used for. Requirements imposed on generated \bbbarmumux decays are included alongside the decay type. The number of generated events includes even numbers for each magnet polarity.}
\label{tab:MC_decays}
\end{center}
\end{table}

Simulated \bsmumu, \bdmumu, \bdkpi and \bujpsik decays for 2012 data taking condition are used for studying the stripping selection in Section X.

The training and testing of multivarite classifiers in Section X uses simulated \bsmumu and \bbbarmumux decays for for 2012 data taking conditions.

Simulated events for \bsmumu, \bskk and \bdkpi for data taken in 2011, 2012, 2015 and 2016 are used for developing the analysis method in Chapter X. 

The production of simulated events is constantly being developed as understanding of the detector increases and to include changes made for each data is recorded at theLHC. Therefore there exists a number of different simulation versions that can be used to simulate events.

Each year data is collected at LHCb the conditions the experiment operates at and the proton collisions delivered by the LHC change. These changes include differences in the the selection used in the trigger for each year and increases in the centre of mass energy of proton collisions. 

Therefore to understand data collected in different years simulated events from each year of data taking is needed, it is important to use similar simulation versions for each year so that the difference in the data taking conditions are not masked by differences in simulation versions. Simiarly for training multivarite classifiers consistent simulation versions are needed for the signal and background samples so that difference between signal and background distributions are not masked by differences in simulation versions.

In general the stripping selections are applied to simulated events, however events that do not pass the stripping selection are still saved and can be used after reprocessing the simulated events. However simulation conditions can be set up so that events that do not pass the stripping selection are discarded and can never be used and also cuts can be applied on particles when they are generated before the detector response is simulated and the events are reconstructed. This is used when a very large same of simulated events needs to be generated in order to have a suitably large same of events reconstructed and is the case for the samples of \bbbarmumux simulated events.

%Two simulated samples of \bbbarmumux is used to understand the long lived combinatorial background and for the training of the multivariate classifier in Section \ref{sec:BDT}. For these samples events that did not pass the stripping selection have not been saved and requirements were applied to the generated events. 
%Simulated \bsmumu events with the same simulation version are also used for training the multivariate classifier to keep the simulation condition consistent.

Although in general simulated events accurately model what occurs in data there are several areas where this is not the case. The distributions of particle identification variables and properties of the underlying proton-proton event, such as the number of tracks in an event, are not well modelled in simulation. %Have I said what an event is?
The mis-modelling of particle identification variables can be corrected for using the PIDCalib package but this is not used directly for this thesis. 
Comparisons of the number of tracks in an event between simulated decays and data can be used to re-weight simulated decays to that the under lying event is accurately modelled. This is described in Sections X.

\subsection{Trigger}
\label{sec:triggerRequirements}

The trigger is the first step in the selection process and the structure of the trigger is described in Section X. Since \bsmumu decays are very rare a broad set of trigger requirements is used in order to keep a high proportion of \bsmumu decay at this step of the selection. Specific trigger lines are not used in the selection but rather the combined results of a large selection of trigger lines at each level of the trigger. The combinations of trigger lines used are the L0Global, Hlt1Phys and Hlt2Phys triggers. The L0Global tigger combines all trigger lines present in the L0 trigger, it selects an event provided at least one L0 selects it and rejects an event if no L0 trigger selects it. The Hlt1Phys and Hlt2Phys triggers are very similar to the L0Global trigger except that decisions are based only trigger lines related to physics processes and HLT trigger lines used for calibration are excluded. 

Different trigger decisions on these lines are used to select decays for the Branching Fration and effective lifetime analyses. The Branching fraction selection imposed the loosest trigger requirements by requiring a event to pass the `Dec' decision at each trigger level as illustrated in set `A' of Table X. Trigger decisions are defined in Section X. The effective lifetime analysis has slightly more constrained trigger requirement, requiring an event passes either the `TIS' or `TOS' decision at each level of the trigger as illustrated in set `B' of Table X. The trigger choice for the effective lifetime is motivated by the determination of the acceptance fuction in Section X. 
%The selection criteria used in trigger lines and the specific lines included in the trigger change with each year of data taking, the dominant lines for triggering \bsmumu decays for each year are shown in Table~X. 

Events are required to be either TIS, triggered independent of signal or TOS, triggered on signal, on the trigger lines used at each level of the trigger.
%The selection criteria used in trigger lines and the specific lines included in the trigger change with each year of data taking, the dominant lines for triggering \bsmumu decays for each year are shown in Table~X. 
Slightly different trigger requirements are used to select \bhh decays used to develop and validate the effective lifetime analysis, the same broad trigger lines are used but the requirement on the output varies depending on the use of the \bhh events. The are two sets of trigger requirments, set `A' and `C', in Table~\ref{tab:triggers} are used to select \bhh decays, it will be made clear in later sections where \bhh decays are used which trigger requirements are imposed. 

\begin{table}[ht]
\begin{center}
\begin{tabular}{ll}
\hline
Trigger Line	& Trigger decision \\ \hline
\multicolumn{2}{c}{{\it set A}} \\ \hline
L0Global	& Dec\\
Hlt1Phys	& Dec \\
Hlt2Phys	& Dec \\ \hline
\multicolumn{2}{c}{{\it set B}} \\ \hline
L0Global	& TIS or TOS \\
Hlt1Phys	& TIS or TOS \\
Hlt2Phys	& TIS or TOS \\ \hline
\multicolumn{2}{c}{{\it set C}} \\ \hline
L0Global	& TIS\\
Hlt1Phys	& TIS \\
Hlt2Phys	& TIS \\ \hline
\end{tabular}
\caption{Trigger lines used to select \bsmumu and \bhh decays. Set `A' is used to select decays for the Branching Fraction analysis. Set `B' is used to select \bsmumu decays for the effective lifetime anaylsis. Sets `A' and `C' are used to select \bhh decays used to develop the \bsmumu effective lifetime analysis.}
\label{tab:triggers}
\end{center}
\end{table}

% An alternative table and therefore the text needs editing.

\begin{landscape}

\begin{table}[ht]
\begin{center}
\begin{tabular}{lllll}
\hline
	   &\multicolumn{4}{c}{Trigger decision} \\ \hline
\cline{2-5}
Trigger Line & Branching Fraction analysis & \bsmumu effective lifetime &\multicolumn{2}{c}{\bhh effective lifetime} \\
             &                             &                            & set A      & set B \\
\cline{4-5}
L0Global	& Dec                      & TIS or TOS                 & TIS        & Dec \\
Hlt1Phys	& Dec                       & TIS or TOS                 & TIS        & Dec \\
Hlt2Phys	& Dec                      & TIS or TOS                 & TIS        & Dec \\ \hline
\end{tabular}
\caption{Trigger lines used to select \bsmumu and \bhh decays. Set `A' is used to select decays for the Branching Fraction analysis. Set `B' is used to select \bsmumu decays for the effective lifetime anaylsis. Sets `A' and `C' are used to select \bhh decays used to develop the \bsmumu effective lifetime analysis.}
\label{tab:triggers2}
\end{center}
\end{table}
\end{landscape}
There was a problem with the implementation of the Hlt2Phys Dec decision in 2016 simulated events.%, the decision returned was always 1.  
This only affect the selection of \bhh decays. In order to emulate this trigger a combination of Hlt2 lines that select \bhh events, listed in Table~\ref{tab:HltDecEmulation}, is used instead of HLT2Phys when the Dec decision is required. 

\begin{table}[ht]
\begin{center}
\begin{tabular}{l}
\bhh trigger lines \\ \hline
Hlt2Topo2BodyDecision Dec  \\
Hlt2B2HH Lb2PPiDecision Dec \\
Hlt2B2HH Lb2PKDecision Dec \\
Hlt2B2HH B2PiPiDecision Dec \\
Hlt2B2HH B2PiKDecision Dec \\
Hlt2B2HH B2KKDecision Dec  \\
Hlt2B2HH B2HHDecision Dec \\ \hline

\end{tabular}
\caption{Trigger lines used to emulate the Hlt2Phys_Dec decision for \bhh data and simulated events.}
\label{tab:HltDecEmulation}
\end{center}
\end{table}

\subsection{Stripping}
\label{sec:stripping}
%http://lhcb-release-area.web.cern.ch/LHCb-release-area/DOC/stripping/config/stripping20/dimuon/strippingbs2mumulineswidemassline.html

\begin{landscape}
\begin{table}[ht]
\begin{center}
\begin{tabular}{llc}
Particle       & Selection cut                                               & Efficiency of \bsmumu cut \\
\hline
\bs            & |M - M$_{PDG}$| $<$ 1200 \mevcc                              & (100.00 $\pm$ 0.00) \\
               & DIRA > 0                                                    & (99.43 $\pm$ 0.01) $\%$\\
               & FD $\chi^{2}$ $>$ 225                                       & (83.89 $\pm$ 0.06) $\%$\\
               & IP $\chi^{2}$ $<$ 25                                        & (96.88 $\pm$ 0.03) $\%$  \\
               & Vertex $\chi^{2}$/ndof < 9                                  & (97.36 $\pm$ 0.03) $\%$\\
              & DOCA $<$ 0.3 mm                                              & (99.86 $/pm$ 0.01) $\%$   \\                          

\hline
$\mu^{+(-)}$   & Track $\chi^{2}$/ndof < 3                                    & -\\
              & isMuon = True                                                & -\\
              & Minimum IP $\chi^{2}$ $>$ 25                                  & (80.47 $\pm$ 0.06) $\%$\\
\hline
\multicolumn{2}{c}{Efficiency after all stripping cuts}                      & (73.75 $\pm$  0.07) $\%$\\
\end{tabular}
\caption{Stripping selection cuts applied to Run 1 events in previous \bsmumu Branching Fraction analyses for select \bsmumu  decays and the efficiencies of the selection cuts on \bsmumu decays from simulated \bsmumu decays.(Note efficiencies are after Dec triggers, these are used in the BF analysis. }
\label{tab:Run1stripping}
\end{center}
\end{table}
\end{landscape}



\begin{landscape}
\begin{table}[ht]
\begin{center}
\begin{tabular}{lll}
Particle              & \bsmumu                                     & \bhh \\
\bs                   & 4900 \mevcc $<$ M $<$ 6000 \mevcc                   & 5180 \mevcc $<$ M $<$ 5500\mevcc                           
                      & DIRA > 0                                             & DIRA > 0                             
                      & FD $\chi^{2}$ $>$ 121                               & FD $\chi^{2}$ $>$ 121                                  
                      & IP $\chi^{2}$ $<$ 25                                & IP $\chi^{2}$ $<$ 25                                
                      & Vertex $\chi^{2}$/ndof < 9                           & Vertex $\chi^{2}$/ndof < 9                               
                      & DOCA $<$ 0.3 mm                                     & DOCA $<$ 0.3 mm                                            
                      & $\tau$ $<$ 13.248 \ps                     & $\tau$ $<$ 13.248 \ps
                      & $p_{T}$ $>$ 500 \mevc                      & $p_{T}$ $>$ 500 \mevc
\hline
Daugther $\mu$ or $h$   & Track $\chi^{2}$/ndof < 3 (4)     & Track $\chi^{2}$/ndof < 3 (4)                                            
                        & isMuon = True                            &                                              
                        & Minimum IP $\chi^{2}$ $>$ 9                        & Minimum IP $\chi^{2}$ $>$ 9                               
                        & 0.25 \gevc $<$ $p_{T}$ $<$ 40 \gevc          & 0.25 \gevc $<$ $p_{T}$ $<$ 40 \gevc
                        & $p$ < 500 \gevc                        & $p$ < 500 \gevc
                        & ghost probability $<$ 0.3 (0.4)              & ghost probability $<$ 0.3 (0.4)
 


\hline
\end{tabular}
\caption{Loose selection cuts applied to select \bsmumu and \bhh decays, where selection is different between Run~1 and Run~2 the Run~2 values are shown in parenthesis next to the Run~1 values.}
\label{tab:fullpreselection}
\end{center}
\end{table}
\end{landscape}


\subsection{Pre-selection/Offline selection?}
\label{sec:offline_sel}

\subsection{Particle Identification}
\label{sec:PID}

\subsection{Multivariate Classifier}
\label{sec:BDT}
